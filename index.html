<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Tournament Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #F9FAFB; /* Light text */
        }
        .sidebar {
            background-color: #1F2937; /* Slightly lighter dark for sidebar */
        }
        .card {
            background-color: #1F2937;
            border: 1px solid #374151;
        }
        .table-header {
            background-color: #374151;
        }
        /* The table-row styles are now mostly for the mobile card view */
        .table-row {
            border-bottom: 1px solid #374151;
        }
        .md\:table-row:nth-child(even) {
            background-color: #1F2937;
        }
        .md\:table-row:nth-child(odd) {
            background-color: #263142;
        }
        .btn-primary {
            background-color: #3B82F6;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2563EB;
        }
        .btn-secondary {
            background-color: #4B5563;
            transition: background-color: 0.3s;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .modal-content {
            background-color: #1F2937;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
        /* Styles for the footer watermark */
        .footer-watermark {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%); /* Adjust for element's own size */
            padding: 8px 12px;
            color: #6B7280; /* Gray text for a watermark effect */
            font-size: 0.75rem; /* text-xs */
            opacity: 0.7; /* Slightly transparent */
            z-index: 10; /* Ensure it's above most content but below modals */
            pointer-events: none; /* Allows clicks to pass through */
        }
    </style>
</head>
<body class="antialiased">

    <div id="authContainer" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-6 card rounded-xl">
            <div class="text-center">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-400 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v1.068A8.001 8.001 0 0120 10a8 8 0 01-8 8s-2.5-1-2.5-3.5a.5.5 0 00-1 0c0 2.5-2.5 3.5-2.5 3.5s-8-4.5-8-8a8.001 8.001 0 018.932-7.932A1 1 0 0111.3 1.046zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                </svg>
                <h1 class="text-3xl font-bold text-white mt-2">TourneyHub</h1>
                <p id="auth-title" class="text-gray-400 mt-2">Sign in to your account</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500" required>
                <input type="password" id="loginPassword" placeholder="Password" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg">Sign In</button>
            </form>
            
            <form id="signupForm" class="space-y-4 hidden">
                 <input type="email" id="signupEmail" placeholder="Email" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500" required>
                <input type="password" id="signupPassword" placeholder="Password" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500" required>
                <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg">Create Account</button>
            </form>
            
            <p id="authError" class="text-sm text-red-400 text-center"></p>
            
            <div class="text-center text-sm">
                <a href="#" id="toggleAuth" class="font-medium text-blue-400 hover:text-blue-300">Don't have an account? Sign Up</a>
            </div>
        </div>
    </div>


    <div id="app" class="flex flex-col md:flex-row min-h-screen hidden">
        <aside class="sidebar w-full md:w-72 lg:w-80 p-6 space-y-6 border-r border-gray-700 flex-shrink-0">
            <header class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v1.068A8.001 8.001 0 0120 10a8 8 0 01-8 8s-2.5-1-2.5-3.5a.5.5 0 00-1 0c0 2.5-2.5 3.5-2.5 3.5s-8-4.5-8-8a8.001 8.001 0 018.932-7.932A1 1 0 0111.3 1.046zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                </svg>
                <h1 class="text-2xl font-bold text-white">TourneyHub</h1>
            </header>
            
            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-gray-300">Controls</h2>
                <button id="addTeamBtn" class="w-full btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    <span>Add New Team</span>
                </button>
                <button id="addFixtureBtn" class="w-full btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    <span>Add Custom Fixture</span>
                </button>
                <button id="resetTournamentBtn" class="w-full btn-secondary text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center justify-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-1.414 1.414A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.5a7.002 7.002 0 0110.001-2.828l1.414-1.414A9.002 9.002 0 004 4.101V3a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    <span>Reset Tournament</span>
                </button>
            </div>

            <div class="space-y-4 pt-4 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-300">Generate Fixtures</h2>
                <div class="space-y-2">
                    <label for="tournamentType" class="block text-sm font-medium text-gray-400">Tournament Type</label>
                    <select id="tournamentType" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="league">League (Round Robin)</option>
                        <option value="knockout">Knockout</option>
                        <option value="friendly">Friendly Match</option>
                    </select>
                </div>
                <button id="generateFixturesBtn" class="w-full btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md">Generate Fixtures</button>
            </div>
            
             <div class="pt-4 mt-auto border-t border-gray-700 text-xs text-gray-400 space-y-3">
                <p>Logged in as: <br><span id="userEmailDisplay" class="font-mono text-gray-300"></span></p>
                <button id="logoutBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Logout</button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div id="loadingIndicator" class="text-center p-10">
                <p class="text-lg text-gray-400">Loading Tournament Data...</p>
            </div>
            <div id="mainContent" class="hidden">
                <div class="mb-6 border-b border-gray-700">
                    <nav class="flex space-x-4" aria-label="Tabs">
                        <button id="tab-points" class="tab-btn text-white font-medium py-3 px-4 border-b-2 border-blue-500">Points Table</button>
                        <button id="tab-fixtures" class="tab-btn text-gray-400 hover:text-white font-medium py-3 px-4 border-b-2 border-transparent">Fixtures</button>
                    </nav>
                </div>

                <div id="pane-points" class="tab-pane">
                    <div class="card rounded-xl overflow-hidden">
                        <div class="p-4 flex justify-between items-center">
                            <h2 class="text-xl font-bold text-white">League Standings</h2>
                            <div class="text-sm text-gray-400">Season 2024-25</div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-300">
                                <thead class="text-xs text-gray-300 uppercase table-header hidden md:table-header-group">
                                    <tr>
                                        <th scope="col" class="pl-6 pr-3 py-3 w-12">Pos</th>
                                        <th scope="col" class="px-3 py-3">Club</th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="mp">MP <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="w">W <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="d">D <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="l">L <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="gf">GF <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="ga">GA <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center sortable" data-sort="gd">GD <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center font-bold sortable" data-sort="pts">Pts <span class="sort-icon"></span></th>
                                        <th scope="col" class="px-3 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pointsTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="pane-fixtures" class="tab-pane hidden">
                    <div class="card rounded-xl overflow-hidden">
                        <div class="p-4">
                           <h2 class="text-xl font-bold text-white">Match Fixtures</h2>
                        </div>
                        <div id="fixturesContainer" class="p-4 space-y-6">
                           </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="addTeamModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-6 rounded-xl shadow-lg m-4">
            <h3 class="text-xl font-bold mb-4">Add a New Team</h3>
            <form id="addTeamForm">
                <div class="mb-4">
                    <label for="teamName" class="block text-sm font-medium text-gray-300 mb-1">Team Name</label>
                    <input type="text" id="teamName" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="teamLogo" class="block text-sm font-medium text-gray-300 mb-1">Team Logo URL (Optional)</label>
                    <input type="url" id="teamLogo" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/logo.png">
                </div>
                <div class="mb-4">
                    <label for="managerName" class="block text-sm font-medium text-gray-300 mb-1">Manager Name</label>
                    <input type="text" id="managerName" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="managerPic" class="block text-sm font-medium text-gray-300 mb-1">Manager Picture URL (Optional)</label>
                    <input type="url" id="managerPic" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/manager.png">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelAddTeam" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Add Team</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editTeamModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-6 rounded-xl shadow-lg m-4">
            <h3 class="text-xl font-bold mb-4">Edit Team</h3>
            <form id="editTeamForm">
                <input type="hidden" id="editTeamId">
                <div class="mb-4">
                    <label for="editTeamName" class="block text-sm font-medium text-gray-300 mb-1">Team Name</label>
                    <input type="text" id="editTeamName" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="editTeamLogo" class="block text-sm font-medium text-gray-300 mb-1">Team Logo URL (Optional)</label>
                    <input type="url" id="editTeamLogo" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/logo.png">
                </div>
                <div class="mb-4">
                    <label for="editManagerName" class="block text-sm font-medium text-gray-300 mb-1">Manager Name</label>
                    <input type="text" id="editManagerName" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="editManagerPic" class="block text-sm font-medium text-gray-300 mb-1">Manager Picture URL (Optional)</label>
                    <input type="url" id="editManagerPic" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/manager.png">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelEditTeam" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addFixtureModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-6 rounded-xl shadow-lg m-4">
            <h3 class="text-xl font-bold mb-4">Add Custom Fixture</h3>
            <form id="addFixtureForm">
                <div class="mb-4">
                    <label for="fixtureTeam1" class="block text-sm font-medium text-gray-300 mb-1">Home Team</label>
                    <select id="fixtureTeam1" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required></select>
                </div>
                <div class="mb-4">
                    <label for="fixtureTeam2" class="block text-sm font-medium text-gray-300 mb-1">Away Team</label>
                    <select id="fixtureTeam2" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required></select>
                </div>
                <div class="mb-4">
                    <label for="fixtureDate" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="fixtureDate" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="fixtureTime" class="block text-sm font-medium text-gray-300 mb-1">Time</label>
                    <input type="time" id="fixtureTime" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" value="19:00" required>
                </div>
                <div class="mb-6">
                    <label for="fixtureRound" class="block text-sm font-medium text-gray-300 mb-1">Round/Stage Name</label>
                    <input type="text" id="fixtureRound" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Friendly, Quarter-Finals">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelAddFixture" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Add Fixture</button>
                </div>
            </form>
        </div>
    </div>

    <div id="enterScoreModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="modal-content w-full max-w-md p-6 rounded-xl shadow-lg m-4">
            <h3 class="text-xl font-bold mb-4">Enter Match Result</h3>
            <form id="enterScoreForm">
                <input type="hidden" id="fixtureId">
                <div class="flex items-center justify-between space-x-4 mb-4">
                    <div class="flex-1 text-center">
                        <img id="modalTeam1Logo" src="" class="mx-auto h-16 w-16 object-contain mb-2 rounded-full bg-white/10 p-1">
                        <p id="modalTeam1Name" class="font-bold"></p>
                        <p id="modalManager1Name" class="text-sm text-gray-400"></p>
                    </div>
                    <div class="text-2xl font-bold text-gray-400">vs</div>
                    <div class="flex-1 text-center">
                        <img id="modalTeam2Logo" src="" class="mx-auto h-16 w-16 object-contain mb-2 rounded-full bg-white/10 p-1">
                        <p id="modalTeam2Name" class="font-bold"></p>
                        <p id="modalManager2Name" class="text-sm text-gray-400"></p>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="matchDate" class="block text-sm font-medium text-gray-300 mb-1">Match Date</label>
                    <input type="date" id="matchDate" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="matchTime" class="block text-sm font-medium text-gray-300 mb-1">Match Time</label>
                    <input type="time" id="matchTime" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center justify-center space-x-4">
                    <input type="number" id="team1Score" class="w-24 text-center bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-2xl" min="0" >
                    <span class="text-2xl font-bold">-</span>
                    <input type="number" id="team2Score" class="w-24 text-center bg-gray-800 border border-gray-600 rounded-lg p-2 text-white text-2xl" min="0" >
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelScore" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="modal-content w-full max-w-sm p-6 rounded-xl shadow-lg m-4">
            <h3 id="confirmTitle" class="text-lg font-bold mb-2">Are you sure?</h3>
            <p id="confirmMessage" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmOk" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <footer class="footer-watermark">
        Developed by xGHOST
    </footer>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, writeBatch, query, getDocs, deleteDoc, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAi80m4-j5zUX8775fKQ7RSiFTFxatE9gE",
            authDomain: "my-tourney-hub.firebaseapp.com",
            projectId: "my-tourney-hub",
            storageBucket: "my-tourney-hub.firebasestorage.app",
            messagingSenderId: "513705892389",
            appId: "1:513705892389:web:d687d4c7d734dc3f2f7dcc",
            measurementId: "G-LYS184J97V"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'football-tourney-default';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let userId = null;
        let teamsUnsubscribe = () => {};
        let fixturesUnsubscribe = () => {};
        let teamsCache = new Map();
        let currentSortColumn = 'pts';
        let currentSortDirection = 'desc';

        // --- UI Elements ---
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('app');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const toggleAuthLink = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('auth-title');
        const authError = document.getElementById('authError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        
        const addTeamBtn = document.getElementById('addTeamBtn');
        const addTeamModal = document.getElementById('addTeamModal');
        const cancelAddTeamBtn = document.getElementById('cancelAddTeam');
        const addTeamForm = document.getElementById('addTeamForm');

        const editTeamModal = document.getElementById('editTeamModal');
        const cancelEditTeamBtn = document.getElementById('cancelEditTeam');
        const editTeamForm = document.getElementById('editTeamForm');

        const addFixtureBtn = document.getElementById('addFixtureBtn'); 
        const addFixtureModal = document.getElementById('addFixtureModal'); 
        const cancelAddFixtureBtn = document.getElementById('cancelAddFixture'); 
        const addFixtureForm = document.getElementById('addFixtureForm'); 
        const fixtureTeam1Select = document.getElementById('fixtureTeam1'); 
        const fixtureTeam2Select = document.getElementById('fixtureTeam2'); 
        
        const pointsTableBody = document.getElementById('pointsTableBody');
        const fixturesContainer = document.getElementById('fixturesContainer');
        const generateFixturesBtn = document.getElementById('generateFixturesBtn');
        const resetTournamentBtn = document.getElementById('resetTournamentBtn');
        const enterScoreModal = document.getElementById('enterScoreModal');
        const cancelScoreBtn = document.getElementById('cancelScore');
        const enterScoreForm = document.getElementById('enterScoreForm');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');

        // --- Utility Functions ---
        
        function generateLogo(name) {
            const colors = ["#ef4444", "#f97316", "#eab308", "#84cc16", "#22c55e", "#14b8a6", "#06b6d4", "#3b82f6", "#8b5cf6", "#d946ef"];
            const charCodeSum = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const bgColor = colors[charCodeSum % colors.length];
            const initial = name.substring(0, 2).toUpperCase();
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100"><rect width="100" height="100" fill="${bgColor}" /><text x="50" y="55" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle" font-family="Arial, sans-serif" font-weight="bold">${initial}</text></svg>`;
            return `data:image/svg+xml;base64,${btoa(svg)}`;
        }

        function showConfirm(title, message) {
            return new Promise(resolve => {
                const confirmModal = document.getElementById('confirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                const confirmOk = document.getElementById('confirmOk');
                const confirmCancel = document.getElementById('confirmCancel');
                const close = (value) => {
                    confirmModal.classList.add('hidden');
                    confirmModal.classList.remove('flex');
                    resolve(value);
                };
                confirmOk.onclick = () => close(true);
                confirmCancel.onclick = () => close(false);
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            });
        }
        
        function clearAppData() {
            pointsTableBody.innerHTML = '';
            fixturesContainer.innerHTML = '';
            teamsCache.clear();
            teamsUnsubscribe();
            fixturesUnsubscribe();
        }

        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // --- Firestore Logic ---
        function setupListeners() {
            if (!userId) return;
            
            loadingIndicator.style.display = 'block';
            mainContent.style.display = 'none';

            teamsUnsubscribe();
            fixturesUnsubscribe();

            const teamsCollectionRef = collection(db, `users/${userId}/teams`);
            teamsUnsubscribe = onSnapshot(teamsCollectionRef, (snapshot) => {
                const teams = [];
                teamsCache.clear();
                snapshot.forEach(doc => {
                    const teamData = { id: doc.id, ...doc.data() };
                    teams.push(teamData);
                    teamsCache.set(doc.id, teamData);
                });
                renderPointsTable(teams);
                populateTeamSelects(teams); 
                loadingIndicator.style.display = 'none';
                mainContent.style.display = 'block';
            }, (error) => {
                console.error("Error fetching teams:", error);
                loadingIndicator.textContent = "Error loading data. Please refresh.";
            });

            const fixturesCollectionRef = collection(db, `users/${userId}/fixtures`);
            fixturesUnsubscribe = onSnapshot(fixturesCollectionRef, (snapshot) => {
                const fixtures = [];
                snapshot.forEach(doc => {
                    fixtures.push({ id: doc.id, ...doc.data() });
                });
                renderFixtures(fixtures);
            }, (error) => {
                console.error("Error fetching fixtures:", error);
            });
        }

        // --- Rendering Logic ---

        function sortTeams(teams, column, direction) {
            teams.sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                // Handle secondary sorting by GD if Pts are equal
                if (column === 'pts' && aValue === bValue) {
                    const aGd = a['gd'];
                    const bGd = b['gd'];
                    if (aGd !== bGd) {
                        return direction === 'asc' ? aGd - bGd : bGd - aGd;
                    }
                }
                
                // Handle secondary sorting by GF if Pts and GD are equal
                if (column === 'pts' && aValue === bValue && a['gd'] === b['gd']) {
                    const aGf = a['gf'];
                    const bGf = b['gf'];
                     if (aGf !== bGf) {
                        return direction === 'asc' ? aGf - bGf : bGf - aGf;
                    }
                }

                if (typeof aValue === 'number' && typeof bValue === 'number') {
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                } 
                
                return direction === 'asc' ? String(aValue).localeCompare(String(bValue)) : String(bValue).localeCompare(String(aValue));
            });
            return teams;
        }
        
        /**
         * Renders the points table with a responsive design.
         * For mobile, it shows cards. For desktop, it shows a full table.
         * @param {Array<Object>} teams - The array of team objects.
         */
        function renderPointsTable(teams) {
            let sortedTeams = sortTeams([...teams], currentSortColumn, currentSortDirection);

            pointsTableBody.innerHTML = '';
            if (teams.length === 0) {
                // A single message for both mobile and desktop views
                pointsTableBody.innerHTML = `<tr class="hidden md:table-row"><td colspan="11" class="text-center py-8 text-gray-400">No teams added yet. Add a team to get started!</td></tr>
                <div class="block md:hidden text-center py-8 text-gray-400">No teams added yet.</div>`;
                return;
            }

            sortedTeams.forEach((team, index) => {
                // DESKTOP VIEW (TABLE ROW) - Hidden on mobile
                const row = document.createElement('tr');
                row.className = 'hidden md:table-row'; // Key class
                row.innerHTML = `
                    <td class="pl-6 pr-3 py-4 font-medium text-white">${index + 1}</td>
                    <td class="px-3 py-4">
                        <div class="flex items-center space-x-3">
                            <img class="h-8 w-8 rounded-full object-contain" src="${team.logoUrl}" alt="${team.name} logo" onerror="this.onerror=null;this.src='${generateLogo(team.name)}';">
                            <div>
                                <div class="font-semibold">${team.name}</div>
                                <div class="text-xs text-gray-400 flex items-center space-x-1.5 mt-1">
                                    <img class="h-4 w-4 rounded-full object-cover" src="${team.managerPicUrl || 'https://placehold.co/32x32/374151/FFFFFF?text=M'}" alt="${team.managerName} photo" onerror="this.onerror=null;this.src='https://placehold.co/32x32/374151/FFFFFF?text=M';">
                                    <span>${team.managerName}</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-center">${team.mp}</td>
                    <td class="px-3 py-4 text-center">${team.w}</td>
                    <td class="px-3 py-4 text-center">${team.d}</td>
                    <td class="px-3 py-4 text-center">${team.l}</td>
                    <td class="px-3 py-4 text-center">${team.gf}</td>
                    <td class="px-3 py-4 text-center">${team.ga}</td>
                    <td class="px-3 py-4 text-center">${team.gd}</td>
                    <td class="px-3 py-4 text-center font-bold text-white">${team.pts}</td>
                    <td class="px-3 py-4 text-center">
                        <button class="edit-team-btn btn-secondary text-xs font-semibold py-1 px-2 rounded-md mr-1" data-team-id="${team.id}">Edit</button>
                        <button class="delete-team-btn bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-2 rounded-md" data-team-id="${team.id}">Delete</button>
                    </td>
                `;
                pointsTableBody.appendChild(row);

                // MOBILE VIEW (CARD) - Hidden on desktop
                const card = document.createElement('div');
                card.className = 'block md:hidden table-row p-4 space-y-4'; // Key class
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="font-medium text-white w-6 text-center">${index + 1}</span>
                            <img class="h-10 w-10 rounded-full object-contain" src="${team.logoUrl}" alt="${team.name} logo" onerror="this.onerror=null;this.src='${generateLogo(team.name)}';">
                            <div>
                                <div class="font-semibold text-base">${team.name}</div>
                                <div class="text-xs text-gray-400">${team.managerName}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg">${team.pts} <span class="text-sm text-gray-400 font-medium">Pts</span></div>
                            <div class="text-sm">${team.gd > 0 ? '+' : ''}${team.gd} <span class="text-xs text-gray-400">GD</span></div>
                        </div>
                    </div>
                    <div>
                        <div class="grid grid-cols-6 gap-2 text-center text-xs text-gray-300 p-2 bg-gray-900/50 rounded-md">
                            <div><span class="font-bold text-gray-400 block">MP</span> ${team.mp}</div>
                            <div><span class="font-bold text-gray-400 block">W</span> ${team.w}</div>
                            <div><span class="font-bold text-gray-400 block">D</span> ${team.d}</div>
                            <div><span class="font-bold text-gray-400 block">L</span> ${team.l}</div>
                            <div><span class="font-bold text-gray-400 block">GF</span> ${team.gf}</div>
                            <div><span class="font-bold text-gray-400 block">GA</span> ${team.ga}</div>
                        </div>
                    </div>
                     <div class="flex justify-end space-x-2 pt-2">
                        <button class="edit-team-btn btn-secondary text-xs font-semibold py-1 px-3 rounded-md" data-team-id="${team.id}">Edit</button>
                        <button class="delete-team-btn bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded-md" data-team-id="${team.id}">Delete</button>
                    </div>
                `;
                pointsTableBody.appendChild(card);
            });

            // Update sort icons for desktop view
            document.querySelectorAll('.sortable .sort-icon').forEach(icon => icon.textContent = '');
            const currentHeader = document.querySelector(`.sortable[data-sort="${currentSortColumn}"] .sort-icon`);
            if (currentHeader) {
                currentHeader.textContent = currentSortDirection === 'asc' ? ' ▲' : ' ▼';
            }
        }
        
        /**
         * Renders the fixtures list with a responsive design.
         * Stacks elements on mobile and arranges them horizontally on larger screens.
         * @param {Array<Object>} fixtures - The array of fixture objects.
         */
        function renderFixtures(fixtures) {
            fixturesContainer.innerHTML = '';
            if (fixtures.length === 0) {
                fixturesContainer.innerHTML = `<div class="text-center py-8 text-gray-400">No fixtures have been generated or added yet.</div>`;
                return;
            }

            fixtures.sort((a, b) => {
                const typeOrder = { 'knockout': 1, 'league': 2, 'friendly': 3 };
                const typeCompare = (typeOrder[a.tournamentType] || 99) - (typeOrder[b.tournamentType] || 99);
                if (typeCompare !== 0) return typeCompare;
                if (a.roundNumber && b.roundNumber) {
                    const roundCompare = a.roundNumber - b.roundNumber;
                    if (roundCompare !== 0) return roundCompare;
                }
                const roundNameA = a.round || ''; const roundNameB = b.round || '';
                const roundNameCompare = roundNameA.localeCompare(roundNameB);
                if (roundNameCompare !== 0) return roundNameCompare;
                const dateA = a.date ? new Date(`${a.date}T${a.time || '00:00'}`) : new Date(0);
                const dateB = b.date ? new Date(`${b.date}T${b.time || '00:00'}`) : new Date(0);
                return dateA - dateB;
            });

            const fixturesBySection = fixtures.reduce((acc, fixture) => {
                let sectionKey = fixture.round || 'Friendly/Custom Matches';
                if (fixture.tournamentType === 'knockout') sectionKey = `Knockout - ${fixture.round || 'Unnamed Round'}`;
                else if (fixture.tournamentType === 'league') sectionKey = `League - ${fixture.round || 'Unnamed Round'}`;
                
                if (!acc[sectionKey]) acc[sectionKey] = [];
                acc[sectionKey].push(fixture);
                return acc;
            }, {});

            Object.keys(fixturesBySection).forEach(sectionKey => {
                const sectionContainer = document.createElement('div');
                sectionContainer.className = 'space-y-3 mb-6';
                const sectionTitle = document.createElement('h3');
                sectionTitle.className = 'text-lg font-semibold text-gray-300 border-b border-gray-700 pb-2 mb-3';
                sectionTitle.textContent = sectionKey;
                sectionContainer.appendChild(sectionTitle);

                fixturesBySection[sectionKey].forEach(fixture => {
                    const team1 = teamsCache.get(fixture.team1Id);
                    const team2 = teamsCache.get(fixture.team2Id);
                    
                    if (!team1 || !team2) { 
                        console.warn('Could not find teams for fixture:', fixture.id);
                        return; 
                    }

                    const fixtureCard = document.createElement('div');
                    // ** RESPONSIVE CHANGE HERE **
                    fixtureCard.className = 'card rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0';

                    const played = fixture.played;
                    const scoreOrTime = played ? 
                        `<div class="text-2xl font-bold">${fixture.score1} - ${fixture.score2}</div>` : 
                        `<div class="text-lg font-semibold text-blue-400">${fixture.time || 'TBD'}</div>`;
                    const matchDateDisplay = fixture.date ? `<div class="text-xs text-gray-400 mt-1">${formatDate(fixture.date)}</div>` : '';

                    fixtureCard.innerHTML = `
                        <div class="flex items-center space-x-3 w-full sm:w-2/5 justify-center sm:justify-end text-right">
                            <span class="font-semibold text-base sm:text-lg truncate">${team1.name}</span>
                            <img src="${team1.logoUrl}" class="h-8 w-8 rounded-full object-contain bg-white/10 p-0.5" onerror="this.onerror=null;this.src='${generateLogo(team1.name)}';">
                        </div>
                        <div class="px-4 text-center">
                            ${scoreOrTime}
                            ${matchDateDisplay}
                        </div>
                        <div class="flex items-center space-x-3 w-full sm:w-2/5 justify-center sm:justify-start">
                            <img src="${team2.logoUrl}" class="h-8 w-8 rounded-full object-contain bg-white/10 p-0.5" onerror="this.onerror=null;this.src='${generateLogo(team2.name)}';">
                            <span class="font-semibold text-base sm:text-lg truncate">${team2.name}</span>
                        </div>
                        <div class="flex space-x-2 sm:flex-col sm:space-y-1 sm:space-x-0 pt-2 sm:pt-0 sm:border-t-0 sm:border-l sm:pl-3 border-gray-700/50 mt-2 sm:mt-0">
                            <button class="edit-score-btn btn-secondary text-xs font-semibold py-1 px-3 rounded-md w-20 text-center" data-fixture-id="${fixture.id}">${played ? 'Edit' : 'Set Score'}</button>
                            <button class="delete-fixture-btn bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded-md w-20 text-center" data-fixture-id="${fixture.id}">Delete</button>
                        </div>
                    `;
                    sectionContainer.appendChild(fixtureCard);
                });
                fixturesContainer.appendChild(sectionContainer);
            });
        }

        function populateTeamSelects(teams) {
            fixtureTeam1Select.innerHTML = '<option value="">Select Home Team</option>';
            fixtureTeam2Select.innerHTML = '<option value="">Select Away Team</option>';
            teams.forEach(team => {
                const option1 = document.createElement('option');
                option1.value = team.id;
                option1.textContent = team.name;
                fixtureTeam1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = team.id;
                option2.textContent = team.name;
                fixtureTeam2Select.appendChild(option2);
            });
        }

        // --- Event Handlers ---
        
        // Auth flow
        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            const isLogin = loginForm.classList.contains('hidden');
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
            authTitle.textContent = isLogin ? 'Sign in to your account' : 'Create a new account';
            toggleAuthLink.textContent = isLogin ? "Don't have an account? Sign Up" : 'Already have an account? Sign In';
            authError.textContent = '';
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => { authError.textContent = error.message; });
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => { authError.textContent = error.message; });
        });
        
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // App flow - Team Management
        addTeamBtn.addEventListener('click', () => {
            addTeamModal.classList.remove('hidden'); addTeamModal.classList.add('flex');
        });
        cancelAddTeamBtn.addEventListener('click', () => {
            addTeamModal.classList.add('hidden'); addTeamModal.classList.remove('flex'); addTeamForm.reset();
        });
        addTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamName = document.getElementById('teamName').value.trim();
            let teamLogo = document.getElementById('teamLogo').value.trim();
            const managerName = document.getElementById('managerName').value.trim();
            let managerPic = document.getElementById('managerPic').value.trim();
            if (!teamName || !managerName) {
                alert("Team Name and Manager Name are required.");
                return;
            }
            if (!teamLogo) teamLogo = generateLogo(teamName);
            const newTeam = { name: teamName, logoUrl: teamLogo, managerName, managerPicUrl: managerPic, mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0 };
            try {
                const teamRef = doc(collection(db, `users/${userId}/teams`));
                await setDoc(teamRef, newTeam);
                addTeamForm.reset(); addTeamModal.classList.add('hidden'); addTeamModal.classList.remove('flex');
            } catch (error) { console.error("Error adding team: ", error); alert("Failed to add team."); }
        });

        // Edit/Delete Team (event delegation)
        pointsTableBody.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-team-btn');
            const deleteBtn = e.target.closest('.delete-team-btn');

            if (editBtn) {
                const teamId = editBtn.dataset.teamId;
                const teamData = teamsCache.get(teamId);
                if (teamData) {
                    document.getElementById('editTeamId').value = teamId;
                    document.getElementById('editTeamName').value = teamData.name;
                    document.getElementById('editTeamLogo').value = teamData.logoUrl;
                    document.getElementById('editManagerName').value = teamData.managerName;
                    document.getElementById('editManagerPic').value = teamData.managerPicUrl;
                    editTeamModal.classList.remove('hidden');
                    editTeamModal.classList.add('flex');
                }
            } else if (deleteBtn) {
                const teamId = deleteBtn.dataset.teamId;
                const teamName = teamsCache.get(teamId)?.name || 'this team';
                const confirmed = await showConfirm("Delete Team?", `Are you sure you want to delete "${teamName}"? This will also delete all associated fixtures.`);
                if (!confirmed) return;

                try {
                    const batch = writeBatch(db);
                    const teamRef = doc(db, `users/${userId}/teams`, teamId);
                    batch.delete(teamRef);

                    const fixturesCollectionRef = collection(db, `users/${userId}/fixtures`);
                    const q = query(fixturesCollectionRef, where("team1Id", "==", teamId));
                    const q2 = query(fixturesCollectionRef, where("team2Id", "==", teamId));
                    
                    const [fixtures1Snap, fixtures2Snap] = await Promise.all([getDocs(q), getDocs(q2)]);

                    fixtures1Snap.forEach(fixtureDoc => batch.delete(fixtureDoc.ref));
                    fixtures2Snap.forEach(fixtureDoc => batch.delete(fixtureDoc.ref));
                    
                    await batch.commit();
                } catch (error) {
                    console.error("Error deleting team:", error);
                    alert("Failed to delete team.");
                }
            }
        });

        cancelEditTeamBtn.addEventListener('click', () => {
            editTeamModal.classList.add('hidden');
            editTeamModal.classList.remove('flex');
            editTeamForm.reset();
        });

        editTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teamId = document.getElementById('editTeamId').value;
            const newName = document.getElementById('editTeamName').value.trim();
            let newLogo = document.getElementById('editTeamLogo').value.trim();
            const newManagerName = document.getElementById('editManagerName').value.trim();
            let newManagerPic = document.getElementById('editManagerPic').value.trim();

            if (!newName || !newManagerName) {
                alert("Team Name and Manager Name are required.");
                return;
            }
            if (!newLogo) newLogo = generateLogo(newName);

            try {
                const teamRef = doc(db, `users/${userId}/teams`, teamId);
                await updateDoc(teamRef, { 
                    name: newName, 
                    logoUrl: newLogo, 
                    managerName: newManagerName, 
                    managerPicUrl: newManagerPic 
                }); 
                editTeamModal.classList.add('hidden');
                editTeamModal.classList.remove('flex');
            } catch (error) {
                console.error("Error updating team:", error);
                alert("Failed to update team.");
            }
        });


        // App flow - Fixture Generation & Custom Fixtures
        addFixtureBtn.addEventListener('click', () => {
            const teams = Array.from(teamsCache.values());
            if (teams.length < 2) {
                alert("You need at least two teams before you can add a custom fixture.");
                return;
            }
            populateTeamSelects(teams);
            document.getElementById('fixtureDate').valueAsDate = new Date(); 
            addFixtureModal.classList.remove('hidden'); addFixtureModal.classList.add('flex');
        });

        cancelAddFixtureBtn.addEventListener('click', () => {
            addFixtureModal.classList.add('hidden'); addFixtureModal.classList.remove('flex'); addFixtureForm.reset();
        });

        addFixtureForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const team1Id = document.getElementById('fixtureTeam1').value;
            const team2Id = document.getElementById('fixtureTeam2').value;
            const fixtureDate = document.getElementById('fixtureDate').value;
            const fixtureTime = document.getElementById('fixtureTime').value;
            const fixtureRound = document.getElementById('fixtureRound').value.trim() || 'Custom Match';

            if (!team1Id || !team2Id) {
                alert("Please select both a home and away team.");
                return;
            }
            if (team1Id === team2Id) {
                alert("Home Team and Away Team cannot be the same.");
                return;
            }
            if (!fixtureDate || !fixtureTime) {
                alert("Please fill all required fields.");
                return;
            }

            const newFixture = {
                team1Id, team2Id, date: fixtureDate, time: fixtureTime, round: fixtureRound,
                played: false, tournamentType: 'friendly'
            };

            try {
                const fixtureRef = doc(collection(db, `users/${userId}/fixtures`));
                await setDoc(fixtureRef, newFixture);
                addFixtureForm.reset();
                addFixtureModal.classList.add('hidden');
                addFixtureModal.classList.remove('flex');
                document.getElementById('tab-fixtures').click(); 
            } catch (error) {
                console.error("Error adding custom fixture: ", error);
                alert("Failed to add custom fixture.");
            }
        });

        generateFixturesBtn.addEventListener('click', async () => {
            const type = document.getElementById('tournamentType').value;
            const teams = Array.from(teamsCache.values());
            const today = new Date();
            const defaultDate = today.toISOString().split('T')[0]; 
            const defaultTime = '19:00'; 

            if (type !== 'friendly' && teams.length < 2) { 
                alert("You need at least 2 teams for a League or Knockout tournament."); return; 
            }
            if (type === 'friendly' && teams.length < 2) {
                alert("You need at least 2 teams to generate a friendly match."); return;
            }

            const confirmed = await showConfirm("Generate Fixtures?", "This will delete all existing fixtures and may reset team stats. Are you sure you want to continue?");
            if (!confirmed) return;
            
            let newFixtures = [];
            
            if (type === 'league') {
                const teamIds = teams.map(t => t.id);
                if (teamIds.length % 2 !== 0) teamIds.push(null); // Add a bye
                const numRounds = teamIds.length - 1; 
                const half = teamIds.length / 2;
                for (let round = 0; round < numRounds; round++) {
                    for (let i = 0; i < half; i++) {
                        const team1Id = teamIds[i]; 
                        const team2Id = teamIds[teamIds.length - 1 - i];
                        if (team1Id && team2Id) { // Ensure no match is created for the bye
                            newFixtures.push({ 
                                team1Id, team2Id, played: false, round: `Round ${round + 1}`, date: defaultDate, time: defaultTime, 
                                tournamentType: 'league', roundNumber: round + 1
                            }); 
                        }
                    }
                    // Rotate teams for next round
                    teamIds.splice(1, 0, teamIds.pop());
                }
            } else if (type === 'knockout') {
                let teamIds = teams.map(t => t.id);
                // Shuffle teams randomly
                for (let i = teamIds.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [teamIds[i], teamIds[j]] = [teamIds[j], teamIds[i]]; }
                let roundCounter = 1;
                for (let i = 0; i < teamIds.length; i += 2) {
                    const team1Id = teamIds[i]; 
                    const team2Id = teamIds[i + 1];
                    if (team2Id) { // If there's a pair
                        newFixtures.push({
                            team1Id, team2Id, played: false, round: `Round of ${Math.pow(2, Math.ceil(Math.log2(teamIds.length)))}`, roundNumber: roundCounter,
                            date: defaultDate, time: defaultTime, tournamentType: 'knockout'
                        });
                    } else { // Handle a bye
                       console.log(`Team ${team1Id} gets a bye.`);
                    }
                }
            } else if (type === 'friendly') {
                let teamIds = teams.map(t => t.id);
                const shuffled = teamIds.sort(() => 0.5 - Math.random());
                newFixtures.push({ team1Id: shuffled[0], team2Id: shuffled[1], played: false, round: 'Friendly Match', date: defaultDate, time: defaultTime, tournamentType: 'friendly', roundNumber: 0 });
            }

            try {
                const batch = writeBatch(db);
                // Delete old fixtures
                const oldFixtures = await getDocs(collection(db, `users/${userId}/fixtures`));
                oldFixtures.forEach(doc => batch.delete(doc.ref));
                // Add new fixtures
                newFixtures.forEach(fixture => { const ref = doc(collection(db, `users/${userId}/fixtures`)); batch.set(ref, fixture); });
                // Reset team stats
                const teamsSnapshot = await getDocs(collection(db, `users/${userId}/teams`));
                teamsSnapshot.forEach(doc => {
                    batch.update(doc.ref, { mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0 });
                });
                await batch.commit();
                document.getElementById('tab-fixtures').click();
            } catch (error) { console.error("Error generating fixtures: ", error); alert("Failed to generate fixtures."); }
        });
        
        resetTournamentBtn.addEventListener('click', async () => {
            const confirmed = await showConfirm("Reset Entire Tournament?", "This will delete ALL teams, fixtures, and scores. This action cannot be undone.");
            if (!confirmed) return;
            try {
                const batch = writeBatch(db);
                const teamsSnapshot = await getDocs(collection(db, `users/${userId}/teams`));
                teamsSnapshot.forEach(doc => batch.delete(doc.ref));
                const fixturesSnapshot = await getDocs(collection(db, `users/${userId}/fixtures`));
                fixturesSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            } catch (error) { console.error("Error resetting tournament:", error); alert("Failed to reset tournament."); }
        });

        // App flow - Score Entry and Fixture Deletion
        fixturesContainer.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-score-btn');
            const deleteBtn = e.target.closest('.delete-fixture-btn');

            if (editBtn) {
                const fixtureId = editBtn.dataset.fixtureId;
                const fixtureDocRef = doc(db, `users/${userId}/fixtures`, fixtureId);
                const docSnap = await getDoc(fixtureDocRef);
                if (docSnap.exists()) {
                    const fixture = {id: docSnap.id, ...docSnap.data()};
                    const team1 = teamsCache.get(fixture.team1Id); 
                    const team2 = teamsCache.get(fixture.team2Id);
                    
                    document.getElementById('fixtureId').value = fixtureId;
                    document.getElementById('modalTeam1Name').textContent = team1 ? team1.name : 'Unknown';
                    document.getElementById('modalTeam2Name').textContent = team2 ? team2.name : 'Unknown';
                    document.getElementById('modalManager1Name').textContent = team1 ? (team1.managerName || 'N/A') : '';
                    document.getElementById('modalManager2Name').textContent = team2 ? (team2.managerName || 'N/A') : '';
                    document.getElementById('modalTeam1Logo').src = team1 ? (team1.logoUrl || generateLogo(team1.name)) : '';
                    document.getElementById('modalTeam2Logo').src = team2 ? (team2.logoUrl || generateLogo(team2.name)) : '';

                    document.getElementById('team1Score').value = fixture.played ? fixture.score1 : '';
                    document.getElementById('team2Score').value = fixture.played ? fixture.score2 : '';
                    document.getElementById('matchDate').value = fixture.date || ''; 
                    document.getElementById('matchTime').value = fixture.time || ''; 
                    
                    enterScoreModal.classList.remove('hidden'); enterScoreModal.classList.add('flex');
                }
            } else if (deleteBtn) {
                const fixtureId = deleteBtn.dataset.fixtureId;
                const confirmed = await showConfirm("Delete Fixture?", "Are you sure you want to delete this fixture? This action won't affect team stats but cannot be undone.");
                if (!confirmed) return;
                try {
                    // Just delete the fixture, don't adjust stats. Let user handle stat correction.
                    await deleteDoc(doc(db, `users/${userId}/fixtures`, fixtureId));
                } catch (error) {
                    console.error("Error deleting fixture:", error);
                    alert("Failed to delete fixture.");
                }
            }
        });

        cancelScoreBtn.addEventListener('click', () => {
            enterScoreModal.classList.add('hidden'); enterScoreModal.classList.remove('flex'); enterScoreForm.reset();
        });

        enterScoreForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fixtureId = document.getElementById('fixtureId').value;
            const newMatchDate = document.getElementById('matchDate').value;
            const newMatchTime = document.getElementById('matchTime').value;
            const score1Input = document.getElementById('team1Score').value;
            const score2Input = document.getElementById('team2Score').value;
        
            const scoresEntered = score1Input.trim() !== '' && score2Input.trim() !== '';
            const fixtureDocRef = doc(db, `users/${userId}/fixtures`, fixtureId);
        
            // If scores are entered, proceed with the full update logic
            if (scoresEntered) {
                const score1 = parseInt(score1Input);
                const score2 = parseInt(score2Input);
        
                const fixtureSnap = await getDoc(fixtureDocRef);
                if (!fixtureSnap.exists()) { alert("Fixture not found!"); return; }
                const fixture = fixtureSnap.data();
                const batch = writeBatch(db);
        
                // Do not update points for friendly matches
                if (fixture.tournamentType !== 'friendly') {
                    const team1Ref = doc(db, `users/${userId}/teams`, fixture.team1Id);
                    const team2Ref = doc(db, `users/${userId}/teams`, fixture.team2Id);
        
                    const [team1Snap, team2Snap] = await Promise.all([getDoc(team1Ref), getDoc(team2Ref)]);
                    if (!team1Snap.exists() || !team2Snap.exists()) { alert("One or both teams no longer exist."); return; }
        
                    let team1Data = team1Snap.data();
                    let team2Data = team2Snap.data();
        
                    // If the match was already played, revert the old stats first
                    if (fixture.played) {
                        const oldScore1 = fixture.score1; const oldScore2 = fixture.score2;
                        team1Data.mp -= 1; team1Data.gf -= oldScore1; team1Data.ga -= oldScore2;
                        team2Data.mp -= 1; team2Data.gf -= oldScore2; team2Data.ga -= oldScore1;
                        if (oldScore1 > oldScore2) { team1Data.w -= 1; team1Data.pts -= 3; team2Data.l -= 1; } 
                        else if (oldScore2 > oldScore1) { team2Data.w -= 1; team2Data.pts -= 3; team1Data.l -= 1; } 
                        else { team1Data.d -= 1; team1Data.pts -= 1; team2Data.d -= 1; team2Data.pts -= 1; }
                    }
        
                    // Apply new stats
                    team1Data.mp += 1; team1Data.gf += score1; team1Data.ga += score2;
                    team2Data.mp += 1; team2Data.gf += score2; team2Data.ga += score1;
                    if (score1 > score2) { team1Data.w += 1; team1Data.pts += 3; team2Data.l += 1; } 
                    else if (score2 > score1) { team2Data.w += 1; team2Data.pts += 3; team1Data.l += 1; } 
                    else { team1Data.d += 1; team1Data.pts += 1; team2Data.d += 1; team2Data.pts += 1; }
        
                    team1Data.gd = team1Data.gf - team1Data.ga;
                    team2Data.gd = team2Data.gf - team2Data.ga;
                    batch.update(team1Ref, team1Data);
                    batch.update(team2Ref, team2Data);
                }
        
                // Update the fixture itself
                batch.update(fixtureDocRef, { played: true, score1, score2, date: newMatchDate, time: newMatchTime });
        
                try {
                    await batch.commit();
                } catch (error) { console.error("Error saving score: ", error); alert("Failed to save score."); }
            } else {
                // If scores are not entered, just update date and time
                try {
                    await updateDoc(fixtureDocRef, { date: newMatchDate, time: newMatchTime });
                } catch (error) { console.error("Error saving date/time: ", error); alert("Failed to save date/time."); }
            }
        
            enterScoreForm.reset();
            enterScoreModal.classList.add('hidden'); enterScoreModal.classList.remove('flex');
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('text-white', 'border-blue-500'); btn.classList.add('text-gray-400', 'border-transparent'); });
                button.classList.add('text-white', 'border-blue-500'); button.classList.remove('text-gray-400', 'border-transparent');
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                document.getElementById(`pane-${button.id.split('-')[1]}`).classList.remove('hidden');
            });
        });

        // Points table sorting
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sort;
                if (currentSortColumn === column) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = column;
                    // Default to descending for points, wins, etc.
                    currentSortDirection = ['gf', 'ga', 'l', 'name'].includes(column) ? 'asc' : 'desc';
                }
                renderPointsTable(Array.from(teamsCache.values()));
            });
        });

        // --- App Initialization ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = user.email;
                authContainer.classList.add('hidden');
                appContainer.classList.add('flex');
                appContainer.classList.remove('hidden');
                setupListeners();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.remove('flex');
                appContainer.classList.add('hidden');
                clearAppData();
            }
        });
    </script>
</body>
</html>
